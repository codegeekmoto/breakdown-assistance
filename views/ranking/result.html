<body class="loading">

    <!-- Vue component -->
    <div id="app">
        <!-- Begin page -->
        <div id="wrapper">

            {{> topbar }}

            {{> left-sidebar }}
            <div class="content-page">
                <div class="content">                    
                    
                    <!-- Start Content-->
                    <div class="container-fluid">
                        
                        <!-- start page title -->
                        <div class="card mt-3">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <h4 class="header-title mb-0 text-uppercase">Ranking Checker: {{ request.name }}</h4>
                                        <small class="font-weight-bold">Here are your result for this request</small>
                                    </div>
                                </div> <!-- end row -->
                            </div> <!-- end card-body-->
                        </div>
                        <!-- end page title --> 

                        <input type="text" hidden name="" id="requestId" value={{request.id}}>

                        <div class="row mb-2">
                            <div class="col-12">
                                <div class="card-box mb-2">
                                    <div class="row align-items-center">
                                        <div class="col-sm-4">
                                            <div class="media">
                                                <div class="media-body">
                                                    <h4 class="mt-0 mb-2 font-16">{{ request.name }}</h4>
                                                    <p class="mb-1"><b>Location:</b> {{ request.market_place }}</p>
                                                    <p class="mb-0"><b>Amount of Keywords:</b> {{ request.keyword_list.length }}</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-4">
                                            <p class="mb-1"><b>Token used:</b> {{ request.token_used }}</p>
                                                    <p class="mb-0"><b>Date Request started:</b> {{ request.created_at }}</p>
                                        </div>
                                        <div class="col-sm-2">
                                            <div class="text-center mt-3 mt-sm-0">
                                                <div class="badge font-14 bg-soft-success text-success p-1">{{ request.status }}</div>
                                            </div>
                                        </div>
                                        <div class="col-sm-2">
                                            <div class="text-sm-right">
                                                <a href="/request/{{request.id}}" class="action-icon"> <i class="mdi mdi-square-edit-outline"></i></a>
                                                <a href="javascript:void(0);" class="action-icon" 
                                                    @click="deleteRequest"> <i class="mdi mdi-delete"></i></a>
                                            </div>
                                        </div> <!-- end col-->
                                    </div> <!-- end row -->
                                </div>
                            </div>
                        </div>
                        <!-- End row -->

                        <!-- <h4 class="header-title mb-3">Results</h4> -->

                        <div class="row mt-3 mb-3">
                            <div class="col-lg-8 mt-1">
                                <h4 class="header-title">Results</h4>
                            </div>
                            <div class="col-lg-4">
                                <div class="text-lg-right mt-3 mt-lg-0">
                                    <button type="button" class="btn btn-sm btn-outline-primary waves-effect waves-light ml-1 ml-1" data-toggle="modal" data-target="#custom-modal"
                                        @click="downloadXlxs">
                                        <i class="fe-download"></i> <span class="font-weight-bold">Download Results</span>
                                    </button>
                                </div>
                            </div><!-- end col-->
                        </div> <!-- end row -->

                        <div class="card-box">
                            <div class="table-responsive">
                                <table class="table mb-0">
                                    <thead class="thead-light">
                                    <tr>
                                        <th>Keyword</th>
                                        {{#each asins }}
                                            <th>{{ this }}</th>
                                        {{/each }}
                                    </tr>
                                    </thead>
                                    <tbody>
                                        {{#each ranks }}
                                            <tr>
                                                {{#each this }}
                                                    <td>{{ this }}</td>
                                                {{/each }}
                                            </tr>
                                        {{/each }}
                                    </tbody>
                                </table>
                            </div> <!-- end table-responsive-->
                        </div>

                    </div> <!-- container -->

                </div> <!-- content -->

                {{> footer }}
            </div>
        </div>
        <!-- END wrapper -->

        {{> right-setting-bar }}

        <textarea id="request" hidden>{{ request }}</textarea>
        <textarea id="asins" hidden>{{ asins }}</textarea>
        <textarea id="keywords" hidden>{{ keywords }}</textarea>

        // Report
        <textarea id="report" hidden>{{ reportData }}</textarea>

    </div>

    <!-- Axios js-->
    <script src="/app/lib/axios.js"></script>
    <!-- vue js -->
    <script src="/app/lib/vue.js"></script>
    <!-- XLXS -->
    <script src="/app/lib/xlxs.js"></script>
    <script src="/app/lib/file-saver.js"></script>
    <script src="/app/lib/xlxs-full.js"></script>

    <script>

        var app = new Vue({
            el: "#app",
            delimiters: ["{%", "%}"],

            data: {
                requestId: document.getElementById("requestId").value,
                request: document.getElementById("request").innerHTML.split(','),
                asins: document.getElementById("asins").innerHTML.split(','),
                keywords: document.getElementById("keywords").innerHTML.split(','),
                reportData: document.getElementById("report").innerHTML.split(','),
                ws: {
                    asinHeader: document.getElementById("asins").innerHTML.split(','),
                    asinTypeHeader: ["Organic - Dektop", "Organic - Mobile", "SP - Dektop", "SP - Mobile"],
                    keyHeader: ['KEYWORD'],

                }
            },
            
            mounted() {
                this.ws.asinHeader.splice(0, 0, '');
            },
            // 
            methods: {

                downloadXlxs: function() {
                    var wb = new Workbook();
                    var ws = {};
                    var rowCellNo = 2;
                    var colLetter = 'B';
                    var merges = []
                    
                    // Set cell range for row 1
                    this.asins.forEach(asin => {
                        // First row asin header
                        merges.push({s:{r:0,c:rowCellNo},e:{r:0,c:rowCellNo + 1}});
                        rowCellNo += 2;
                        colLetter = this.nextChar(colLetter, 2);
                    });

                    ws["!merges"] = merges;

                    var defaultStyle = {
                        height: 30,
                        alignment: {
                            horizontal: 'center'
                        }
                    };

                    var boldDefaultStyle = {
                        alignment: {
                            horizontal: 'center'
                        },
                        font: {
                            bold: true
                        }
                    };

                    var leftDefaultStyle = {
                        alignment: {
                            horizontal: 'left'
                        }
                    };

                    var rightDefaultStyle = {
                        alignment: {
                            horizontal: 'right'
                        }
                    };

                    var leftBoldDefaultStyle = {
                        alignment: {
                            horizontal: 'left'
                        },
                        font: {
                            bold: true
                        }
                    };

                    var asinStyle1 = {
                        fill: { 
                            fgColor: { rgb: "fcf5cc"},
                        },
                        alignment: {
                            horizontal: 'center'
                        }
                    };

                    var asinStyle2 = {
                        fill: { 
                            fgColor: { rgb: "d7dde0"},
                        },
                        alignment: {
                            horizontal: 'center'
                        },
                        range: 5
                    };
                    
                    var asinHeadStyle = asinStyle2;
                    var sheetName = "Ranking";
                    var wscols=[];

                    // Asin header (row 1)
                    fillCelluleByAddress(wb,ws, sheetName, null, createObjetRowCol(1,1), defaultStyle);
                    var colIndex = 3;
                    for (let i = 0; i < this.asins.length; i++) {
                        asinHeadStyle = asinHeadStyle == asinStyle2 ? asinStyle1 : asinStyle2;
                        fillCelluleByAddress(wb,ws, sheetName, this.asins[i], createObjetRowCol(1, colIndex), asinHeadStyle);
                        colIndex += 2;
                    }

                    // Set cell width
                    setColWithToSheet(ws, wscols, 0, 16);
                    for (let i = 1; i < colIndex; i++) {
                        setColWithToSheet(ws, wscols, i, 17);
                    }

                    colIndex = 3;
                    fillCelluleByAddress(wb,ws, sheetName, "KEYWORD", createObjetRowCol(2, 1), leftBoldDefaultStyle);
                    fillCelluleByAddress(wb,ws, sheetName, "Volume", createObjetRowCol(2, 2), boldDefaultStyle);
                    this.asins.forEach(element => {
                        fillCelluleByAddress(wb,ws, sheetName, "Organic - Desktop", createObjetRowCol(2, colIndex), boldDefaultStyle);
                        fillCelluleByAddress(wb,ws, sheetName, "Sp - Desktop", createObjetRowCol(2, colIndex+1), boldDefaultStyle);
                        // fillCelluleByAddress(wb,ws, sheetName, "SP - Desktop", createObjetRowCol(2, colIndex+2), boldDefaultStyle);
                        // fillCelluleByAddress(wb,ws, sheetName, "SP - Mobile", createObjetRowCol(2, colIndex+3), boldDefaultStyle);
                        colIndex += 2;
                    });

                    var colNum = 1;
                    var rowNum = 3;
                    var counter = 1;

                    this.reportData.forEach(data => {
                        data = data == 0 ? '': data;
                        fillCelluleByAddress(wb,ws, sheetName, data, createObjetRowCol(rowNum, colNum), null);
                        colNum++;
                        if (counter === (this.asins.length * 2) + 2) {
                            rowNum++;
                            colNum = 1;
                            counter = 0;
                        }
                        counter++;
                    });

                    var wopts = setWopts();
                    saveFile(wb,wopts,'Ranking-Result.xlsx');
                },

                // Api calls
                fetchResult: function(requestId) {
                    axios.post('/ranking/request', this.request)
                        .then((result) => {
                            console.log('Result', result.data);
                        }).catch((err) => {
                            console.log('Error', err);
                        });
                },

                deleteRequest: function() {
                    bootbox.confirm({
                        title: 'Confirm',
                        message: `Are you sure you want to delete request?`,
                        centerVertical: true,
                        buttons: {
                            confirm: {
                                label: 'Delete',
                                className: 'btn-danger'
                            }
                        },

                        callback: function (isDelete) {
                            
                            if (isDelete) {
                                axios.delete('/api/ranking/delete/' + app.requestId)
                                    .then((result) => {
                                        toastr.success('Request successfully deleted!')
                                        window.location.href = '/';
                                    }).catch((err) => {
                                        toastr.error('Failed to rename request! Try again.')
                                    });
                            }

                        }
                    });
                },

                // Helper functions

                nextChar: function(char, incrementNo) {
                    return String.fromCharCode(char.charCodeAt(0) + incrementNo)
                },

                sheet_to_workbook(sheet, opts) {
                    var n = opts && opts.sheet ? opts.sheet : "Sheet1";
                    var sheets = {}; sheets[n] = sheet;
                    return { SheetNames: [n], Sheets: sheets };
                },

                aoa_to_workbook(data, opts) {
                    return this.sheet_to_workbook(XLSX.utils.aoa_to_sheet(data, opts), opts);
                },

                logout() {
                    axios.post('/logout')
                        .then(result => {
                            window.location.href = '/login';
                        }).catch(err => {
                            console.log('Error', err);
                        });
                }
                
            }
        })


    </script>

    {{> theme-script }}
    
</body>